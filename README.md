# 材料費原価計算エンジン

直接材料費の原価計算と入出庫履歴の作成を自動化するRustアプリケーションです。Excelファイルから生産データ、配合マスタ、仕入データ、売上データを読み取り、材料費計算と在庫管理を実行して結果をExcelファイルに出力します。

## ユースケース

本システムは2つのユースケースを提供します：

1. **材料費の算出**
2. **入出庫履歴の作成**

### ユースケース1: 材料費の算出

#### 概要

生産管理において、製品を製造する際に消費される材料の費用を正確に計算します。生産数量、配合比率、仕入単価などの情報を基に、以下の計算を自動化します：

1. 原砂金額の算出
2. 原単位（円/t）の算定
3. 原砂歩留金額の算定
4. 材料費合計の算定

#### アクター

- **ユーザー**: 原価計算を実行する担当者

#### 事前条件

- 入力Excelファイルが存在すること
- 以下のシートが正しいフォーマットで存在すること：
  - 【入庫】生産
  - 【入庫】仕入
  - 配合マスタ

#### 基本フロー

1. **システム起動**
   - ユーザーがアプリケーションを実行
   - システムが`config.toml`から入出力ファイルパスを読み込む

2. **リポジトリ初期化**
   - 配合マスタデータを読み込み、メモリに保持
   - 仕入データを読み込み、最新単価情報を保持
   - 生産データを読み込み、バリデーション実行

3. **生産データ処理**（各行ごとに実行）
   
   a. **配合マスタ検索**
   - 商品コードをキーに配合マスタを検索
   - 材料となる原砂と消費比率を特定
   
   b. **材料消費数量計算**
   - 各材料について：消費数量 = 生産数量 × 消費比率
   
   c. **仕入単価取得**
   - 各材料の商品コードで仕入データを検索
   - 最新の仕入単価を取得
   
   d. **原砂金額算出**
   - 各材料について：材料費 = 消費数量 × 仕入単価
   - 原砂金額 = 全材料費の合計
   
   e. **原単位算定**
   - 原単位（円/t） = 原砂金額 ÷ 1000
   
   f. **原砂歩留金額算定**
   - 原砂歩留金額 = 原砂金額 × 歩留率
   
   g. **材料費合計算定**
   - 材料費 = 原砂歩留金額 + 凝集剤 + 粘土処理

4. **結果出力**
   - 計算結果を【入庫】生産シートの該当列に書き込む

#### 事後条件

- 【入庫】生産シートに以下の計算結果が記入される：
  - 原砂金額
  - 原単位（円/t）
  - 原砂歩留金額
  - 材料費

### ユースケース2: 入出庫履歴の作成

#### 概要

生産、仕入、売上の各トランザクションから、商品ごとの在庫推移を時系列で記録します。在庫残高の管理と追跡を可能にします。

#### アクター

- **ユーザー**: 在庫管理を実行する担当者

#### 事前条件

- 入力Excelファイルが存在すること
- 以下のシートが正しいフォーマットで存在すること：
  - 【入庫】生産
  - 【入庫】仕入
  - 【出庫】売上
  - 【集計】入出庫履歴

#### 基本フロー

1. **トランザクション収集**
   - 【入庫】生産シートから生産トランザクションを読み込む
   - 【入庫】仕入シートから仕入トランザクションを読み込む
   - 【出庫】売上シートから売上トランザクションを読み込む

2. **トランザクションソート**
   - 日付順にソート
   - 同一日付の場合は商品コード順にソート

3. **在庫残高計算**（各トランザクションごとに実行）
   
   a. **基準数量の取得**
   - 商品ごとの現在の在庫残高を取得
   
   b. **増減数量の計算**
   - 生産・仕入：在庫を加算（正の値）
   - 売上：在庫を減算（負の値）
   
   c. **新残高の算出**
   - 新残高 = 基準数量 + 増減数量
   
   d. **履歴レコード作成**
   - 入出庫日、在庫区分、商品コード、商品名、基準数量、増減数量、在庫残高を記録

4. **結果出力**
   - 【集計】入出庫履歴シートに全レコードを書き込む

#### 事後条件

- 【集計】入出庫履歴シートに以下の情報が記入される：
  - 入出庫日
  - 在庫区分（生産/仕入/売上）
  - 商品コード
  - 商品名
  - 基準数量
  - 増減数量
  - 在庫残高(KG)

## 入力データ仕様

### 【入庫】生産シート

| カラム名 | 必須 | 型 | 説明 |
|---------|------|-----|------|
| 生産日 | ○ | 日付 | 生産日（YYYY-MM-DD, YYYY/MM/DD, YYYY.MM.DD形式） |
| 商品コード | ○ | 文字列 | 製造する商品の識別コード |
| 生産品番 | ○ | 文字列 | 生産品の品番 |
| 生産数量 | ○ | 数値 | 生産する数量（kg） |
| 原砂金額 | - | 数値 | 計算結果（出力） |
| 原単位（円/ｔ） | - | 数値 | 計算結果（出力） |
| 歩留率 | ○ | 数値 | 歩留率（0.0～1.0） |
| 原砂歩留金額 | - | 数値 | 計算結果（出力） |
| 凝集剤 | - | 数値 | 凝集剤の費用（円）、空白可 |
| 粘土処理 | - | 数値 | 粘土処理の費用（円）、空白可 |
| 材料費 | - | 数値 | 計算結果（出力） |

### 【入庫】仕入シート

| カラム名 | 必須 | 型 | 説明 |
|---------|------|-----|------|
| 仕入日 | ○ | 日付 | 仕入日（YYYY-MM-DD, YYYY/MM/DD, YYYY.MM.DD形式） |
| 商品コード | ○ | 文字列 | 材料の識別コード |
| 商品 | ○ | 文字列 | 材料名 |
| 規格 | - | 文字列 | 規格 |
| 数量 | ○ | 数値 | 仕入数量（kg） |
| 単位 | - | 文字列 | 単位 |
| 仕入単価 | ○ | 数値 | 単価（円） |
| 仕入額 | - | 数値 | 仕入額（円） |

### 【出庫】売上シート

| カラム名 | 必須 | 型 | 説明 |
|---------|------|-----|------|
| 売上日 | ○ | 日付 | 売上日（YYYY-MM-DD, YYYY/MM/DD, YYYY.MM.DD形式） |
| 商品コード | ○ | 文字列 | 商品の識別コード |
| 商品名 | ○ | 文字列 | 商品名 |
| 規格 | - | 文字列 | 規格 |
| 倉庫 | - | 文字列 | 倉庫名 |
| 数量 | ○ | 数値 | 売上数量（kg） |
| 単位 | - | 文字列 | 単位 |

### 配合マスタシート

| カラム名 | 必須 | 型 | 説明 |
|---------|------|-----|------|
| 製造商品コード | ○ | 文字列 | 製造する商品の識別コード |
| 材料商品コード | ○ | 文字列 | 使用する材料の識別コード |
| 消費比率 | ○ | 数値 | 材料の消費比率 |

### 【集計】入出庫履歴シート（出力）

| カラム名 | 型 | 説明 |
|---------|-----|------|
| 入出庫日 | 日付 | トランザクション日付 |
| 在庫区分 | 文字列 | 生産/仕入/売上 |
| 商品コード | 文字列 | 商品の識別コード |
| 商品名 | 文字列 | 商品名 |
| 基準数量 | 数値 | トランザクション前の在庫残高（kg） |
| 増減数量 | 数値 | 増減数量の絶対値（kg） |
| 在庫残高(KG) | 数値 | トランザクション後の在庫残高（kg、負の値も許容） |

## 計算式

### 材料費計算

#### 原砂金額

```
原砂金額 = Σ(材料消費数量 × 仕入単価)

ここで、
材料消費数量 = 生産数量 × 消費比率
```

#### 原単位（円/t）

```
原単位 = 原砂金額 ÷ 1000
```

#### 原砂歩留金額

```
原砂歩留金額 = 原砂金額 × 歩留率
```

#### 材料費

```
材料費 = 原砂歩留金額 + 凝集剤 + 粘土処理
```

### 在庫残高計算

```
新残高 = 基準数量 + 増減数量

ここで、
増減数量 = {
  生産・仕入の場合: +数量
  売上の場合: -数量
}
```

## 設定

`config.toml`で入出力ファイルパスを設定します。

```toml
[paths]
input_file = "tests/直接材料費原価計算表.xlsx"
output_file = "tests/直接材料費原価計算表_結果.xlsx"
```

## 使用方法

### ビルド

```bash
cargo build --release
```

### 実行

```bash
cargo run --release
```

または

```bash
./target/release/material_cost_engine
```

### 実行結果

- コンソールに処理状況が表示されます
- 計算結果が出力ファイルに保存されます
- syslogシートに全ログが記録されます
- エラーが発生した場合は、詳細なエラーメッセージが表示されます

## エラーハンドリング

すべてのエラーは適切にハンドリングされ、ユーザーに分かりやすいメッセージで通知されます。

- **ファイルアクセスエラー**: ファイルが開けない、保存できない
- **スキーマエラー**: 必須カラムが見つからない
- **データエラー**: 必須項目が空白、数値が不正、日付形式が不正
- **ビジネスロジックエラー**: 配合マスタ未登録、仕入データ未登録

### 日付バリデーション

日付は以下の形式をサポートします：
- YYYY-MM-DD (例: 2024-01-15)
- YYYY/MM/DD (例: 2024/01/15)
- YYYY.MM.DD (例: 2024.01.15)

Excelのシリアル値（数値）も自動的に日付形式に変換されます。

## 技術スタック

- **言語**: Rust 2024 Edition
- **Excelライブラリ**: 
  - `calamine` (読み取り)
  - `rust_xlsxwriter` (書き込み)
- **日付処理**: `chrono`
- **エラーハンドリング**: `color-eyre`
- **設定管理**: `toml`, `serde`

## ライセンス

このプロジェクトは内部使用を目的としています。
